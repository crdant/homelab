#!/usr/bin/env bash
BASEDIR=`dirname $0`/..
. "${BASEDIR}/lib/env.sh"
. "${BASEDIR}/lib/generate_passphrase.sh"
. "${BASEDIR}/lib/terraform.sh"
set -e

vsphere_password="$(security find-generic-password -a root -s ${vsphere_host} -w)"
vcenter_password="$(security find-generic-password -a root -s ${vcenter_host}.${domain} -w)"

vsphere_license="$(security find-generic-password -a license_key -s ${vsphere_host} -w)"
vcenter_license="$(security find-generic-password -a license_key -s ${vcenter_host} -w)"

terraform_vars () {
  env -i BASEDIR=${BASEDIR} \
    vsphere_password=${vsphere_password} \
    vsphere_license=${vsphere_license} vcenter_license=${vcenter_license}  \
    bash -c 'set -a ; . "${BASEDIR}/lib/env.sh" ; set +a ; jq -n env'
}

if [ $# -gt 0 ]; then
  while [ $# -gt 0 ]; do
    case $1 in
      init )
        init pave
        ;;
      apply )
        apply pave
        ;;
      destroy )
        destroy pave
        ;;
      outputs )
        outputs pave
        ;;
      vars )
        terraform_vars
        ;;
      * )
        echo "Unrecognized option: $1" 1>&2
        exit 1
        ;;
    esac
    shift
  done
  exit
fi

init pave
apply pave
