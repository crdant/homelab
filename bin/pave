#!/usr/bin/env bash
BASEDIR=`dirname $0`/..
. "${BASEDIR}/lib/env.sh"
. "${BASEDIR}/lib/generate_passphrase.sh"
set -e

vcenter_password="$(security find-generic-password -a root -s ${vcenter_host}.${domain} -w)"

init () {
  terraform init ${terraform_dir}/pave
}

apply () {
  terraform apply \
    --auto-approve \
    --var "domain=${domain}" \
    --var "email=${email}" \
    --var "vcenter_password=\"${vcenter_password}\"" \
    --var "vcenter_host=${vcenter_host}" \
    --var "bosh_director_role=${bosh_director_role}" \
    --var "bosh_director_group=${bosh_director_group}" \
    --var "key_dir=${key_dir}" \
    --var "state_dir=${state_dir}" \
    --var "template_dir=${template_dir}" \
    --var "work_dir=${work_dir}" \
    ${terraform_dir}/pave
}

if [ $# -gt 0 ]; then
  while [ $# -gt 0 ]; do
    case $1 in
      init )
        init
        ;;
      apply )
        apply
        ;;
      * )
        echo "Unrecognized option: $1" 1>&2
        exit 1
        ;;
    esac
    shift
  done
  exit
fi

init
apply
