#!/usr/bin/env bash
BASEDIR=`dirname $0`/..
. "${BASEDIR}/lib/env.sh"
. "${BASEDIR}/lib/generate_passphrase.sh"
. "${BASEDIR}/lib/terraform.sh"

set -e

vsphere_password="$(security find-generic-password -a root -s ${vsphere_host} -w)"

terraform_vars () {
  env -i BASEDIR=${BASEDIR} \
    vsphere_password=${vsphere_password} \
    bash -c 'set -a ; . "${BASEDIR}/lib/env.sh" ; set +a ; jq -n env'
}

if [ $# -gt 0 ]; then
  while [ $# -gt 0 ]; do
    case $1 in
      init )
        init vsphere
        ;;
      apply )
        apply vsphere
        ;;
      destroy )
        destroy vsphere
        ;;
      vars )
        terraform_vars
        ;;
      *)
        echo "Unrecognized option: $1" 1>&2
        exit 1
        ;;
    esac
    shift
    exit
  done
fi

init vsphere
apply vsphere
