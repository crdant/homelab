#!/usr/bin/env bash
BASEDIR=`dirname $0`/..
. "${BASEDIR}/lib/env.sh"
. "${BASEDIR}/lib/generate_passphrase.sh"
. "${BASEDIR}/lib/terraform.sh"

set -e

vsphere_password="$(security find-generic-password -a root -s ${vsphere_host} -w)"

terraform_vars () {
  env -i BASEDIR=${BASEDIR} \
    vsphere_password=${vsphere_password} \
    bash -c 'set -a ; . "${BASEDIR}/lib/env.sh" ; set +a ; jq -n env'
}

renew () {
  target vsphere "acme_certificate.esxi"
  target vsphere "local_file.esxi_certificate"
  target vsphere "local_file.esxi_private_key"
  target vsphere "acme_certificate.vcenter"
  target vsphere "local_file.vcenter_certificate"
  target vsphere "local_file.vcenter_private_key"
}

if [ $# -gt 0 ]; then
  while [ $# -gt 0 ]; do
    case $1 in
      init )
        init vsphere
        ;;
      apply )
        apply vsphere
        ;;
      destroy )
        destroy vsphere
        ;;
      outputs )
        outputs vsphere
        ;;
      vars )
        terraform_vars
        ;;
      renew )
        renew
        ;;
      *)
        echo "Unrecognized option: $1" 1>&2
        exit 1
        ;;
    esac
    shift
    exit
  done
fi

init vsphere
apply vsphere
