#!/usr/bin/env bash
BASEDIR=`dirname $0`/..
. "${BASEDIR}/lib/env.sh"
. "${BASEDIR}/lib/generate_passphrase.sh"
. "${BASEDIR}/lib/terraform.sh"
set -e

concourse_github_client="$(security find-generic-password -a "Concourse Client" -s github.com -w)"
concourse_github_secret="$(security find-generic-password -a "Concourse Secret" -s github.com -w)"

# defaults that can be overridden in ${BASEDIR}/lib/env.sh, essentially these are currently
# per my most recent major rebuild
default_stemcell_os=ubuntu-xenial
default_stemcell_version=97.15
default_stemcell_sha=f3fa12c62892de8df5d404a6fb0875a3fb340569
default_web_vm_type=small
default_db_vm_type=small
default_worker_vm_type=small
default_db_disk_type=50GB

prepare () {
  git clone https://github.com/concourse/concourse-bosh-deployment.git ${work_dir}/concourse
}

environment () {
  source_json="$(outputs pave)"

  export BBL_IAAS=${iaas}
  export BBL_VSPHERE_VCENTER_USER="$(echo "$source_json" | jq -r .bbl_user.value )"
  export BBL_VSPHERE_VCENTER_PASSWORD="$(echo "$source_json" | jq -r .bbl_password.value )"
  export BBL_VSPHERE_VCENTER_IP="$(echo "$source_json" | jq -r .vcenter_fqdn.value )"
  export BBL_VSPHERE_VCENTER_DC="$(echo "$source_json" | jq -r .bbl_datacenter.value )"
  export BBL_VSPHERE_VCENTER_CLUSTER="$(echo "$source_json" | jq -r .bbl_cluster.value )"
  export BBL_VSPHERE_VCENTER_RP="$(echo "$source_json" | jq -r .bbl_resource_pool.value )"
  export BBL_VSPHERE_NETWORK="$(echo "$source_json" | jq -r .bootstrap_network.value )"
  export BBL_VSPHERE_VCENTER_DS="$(echo "$source_json" | jq -r .bbl_datastore.value )"
  export BBL_VSPHERE_SUBNET="$(echo "$source_json" | jq -r .bootstrap_cidr.value )"
  export BBL_VSPHERE_VCENTER_DISKS
  export BBL_VSPHERE_VCENTER_TEMPLATES
  export BBL_VSPHERE_VCENTER_VMS
}

patch () {
  local job="bootstrap"
  cp -r ${terraform_dir}/${job}/. ${state_dir}/terraform
  cp -r ${cloud_config_dir}/${job}/. ${state_dir}/cloud-config
  env -i BASEDIR=${BASEDIR} \
    concourse_main_github_user="${concourse_main_github_user:-$user}" \
    concourse_main_github_org="${concourse_main_github_org}" \
    concourse_github_client="${concourse_github_client}" \
    concourse_github_secret="${concourse_github_secret}" \
    bash -c 'set -a ; . "${BASEDIR}/lib/env.sh" ; set +a ; jq -n env' > ${state_dir}/vars/${job}.tfvars
}

plan () {
  environment
  bbl plan --debug --state-dir ${state_dir}
}

up () {
  environment
  bbl up --debug --state-dir ${state_dir}
  # refresh variables
  . "${BASEDIR}/lib/env.sh"
}

deploy () {
  eval "$(bbl print-env)"
  concourse_uaa
  deploy_concourse
}

concourse_uaa () {
  # create a UAA client for Concourse to access Credhub
  uaac target $(echo $BOSH_ENVIRONMENT | cut -d ":" -f2 | tr -d '/'):8443 --ca-cert <(bbl director-ca-cert)
  uaac token client get uaa_admin --secret "${uaa_admin_client_secret}"
  uaac client get ${concourse_credhub_client_id:-concourse}
  if [ ! $? ] ; then
    concourse_credhub_client_secret="$(grep concourse_credhub_client_secret ${state_dir}/vars/cloud-config-vars.yml | cut -d ":" -f2 | tr -d ' ')"
    uaac client add ${concourse_credhub_client_id:-concourse} --name "${concourse_fqdn}" --secret ${concourse_credhub_client_secret} --scope uaa.none --authorized_grant_types client_credentials --authorities "credhub.write,credhub.read";
  fi
}

deploy_concourse () {
  # upload stemcell
  bosh upload-stemcell --sha1 ${concourse_stemcell_sha:-$default_stemcell_sha} \
    https://bosh.io/d/stemcells/bosh-vsphere-esxi-${concourse_stemcell_os:-$default_stemcell_os}-go_agent?v=${concourse_stemcell_version:-$default_stemcell_version}

  # deploy with TLS, a static web IP, and github authentication
  bosh -n -e "$(bbl env-id)" deploy -d concourse ${work_dir}/concourse/cluster/concourse.yml \
    -l ${work_dir}/concourse/versions.yml \
    --vars-file ${state_dir}/vars/director-vars-store.yml \
    --vars-file ${state_dir}/vars/cloud-config-vars.yml \
    --vars-file ${work_dir}/bootstrap/concourse-vars.yml \
    -o ${work_dir}/concourse/cluster/operations/static-web.yml \
    -o ${work_dir}/concourse/cluster/operations/tls-port.yml \
    -o ${work_dir}/concourse/cluster/operations/tls-vars.yml \
    -o ${work_dir}/concourse/cluster/operations/tls.yml \
    -o ${work_dir}/concourse/cluster/operations/basic-auth.yml \
    -o ${work_dir}/concourse/cluster/operations/github-auth.yml \
    --var web_vm_type=${concourse_web_vm_type:-$default_web_vm_type} \
    --var db_vm_type=${concourse_db_vm_type:-$default_db_vm_type} \
    --var db_persistent_disk_type=${concourse_db_disk_type:-$default_db_disk_type} \
    --var worker_vm_type=${concourse_worker_vm_type:-$default_worker_vm_type}

    concourse_login
}

concourse_login () {
  fly --target "${env_id}"  login --team-name main --concourse-url=${concourse_url} --ca-cert=${ca_cert_file} --username="${concourse_main_basic_user}" --password="${concourse_main_basic_password}"
}

login() {
  eval "$(bbl print-env)"
  export BOSH_ENVIRONMENT=$(bbl director-address)
  bosh -n alias-env $(bbl env-id)
  bosh -n log-in
}

down () {
  environment
  bbl down --debug --state-dir ${state_dir}
}

if [ $# -gt 0 ]; then
  while [ $# -gt 0 ]; do
    case $1 in
      prepare )
        prepare
        ;;
      plan )
        plan
        ;;
      patch )
        patch
        ;;
      up )
        up
        ;;
      deploy )
        deploy
        ;;
      login )
        login
        ;;
      down )
        down
        ;;
      * )
        echo "Unrecognized option: $1" 1>&2
        exit 1
        ;;
    esac
    shift
    exit
  done
fi

prepare
plan
patch
up
login
deploy
